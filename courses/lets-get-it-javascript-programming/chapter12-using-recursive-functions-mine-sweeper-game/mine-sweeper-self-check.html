<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì§€ë¢° ì°¾ê¸°</title>
  <style>
    table { border-collapse: collapse; }
    td {
      border: 1px solid #bbb;
      text-align: center;
      line-height: 25px;
      width: 25px;
      height: 25px;
      background: #888;
    }
    td.opened { background: white; }
    td.flag { background: red; }
    td.question { background: orange; }
  </style>
</head>

<body>
  <form id="form">
    <input placeholder="ê°€ë¡œ ì¤„" id="row" size="5" />
    <input placeholder="ì„¸ë¡œ ì¤„" id="cell" size="5" />
    <input placeholder="ì§€ë¢°" id="mine" size="5" />
    <button>ìƒì„±</button>
  </form>
  <div id="timer">0ì´ˆ</div>
  <table id="table">
    <tbody></tbody>
  </table>
  <div id="result"></div>
  <script>
    const $form = document.querySelector('#form');
    const $timer = document.querySelector('#timer');
    const $tbody = document.querySelector('#table tbody');
    const $result = document.querySelector('#result');
    let row; // ì¤„
    let cell; // ì¹¸
    let mine; // ì§€ë¢°
    const CODE = {
      NORMAL: -1,
      QUESTION: -2,
      FLAG: -3,
      QUESTION_MINE: -4,
      FLAG_MINE: -5,
      MINE: -6,
      OPENED: 0, // 0 ì´ìƒì´ë©´ ëª¨ë‘ ì—´ë¦° ì¹¸
    }
    // ê°œì¸ ë„ì „ 3. ë¬¼ìŒí‘œ, ê¹ƒë°œ, ì§€ë¢°, í­ë°œí•œ ì§€ë¢°ë¥¼ ì´ëª¨ì§€ë¡œ ë³€ê²½
    const CODE_TEXT = {
      FLAG: 'ğŸš©',
      MINE: 'ğŸ’£',
      QUESTION: 'â”',
    }
    let data;
    let openCount = 0;
    let startTime;
    let interval;
    let firstClick;
    let mines; // ì§€ë¢°ë¥¼ ë‹´ì„ ë°°ì—´

    function onSubmit(event) {
      event.preventDefault();
      row = parseInt(event.target.row.value);
      cell = parseInt(event.target.cell.value);
      mine = parseInt(event.target.mine.value);

      // ê°œì¸ ë„ì „ 1. ì§€ë¢° ê°œìˆ˜ì— ëŒ€í•œ ì˜ˆì™¸ì²˜ë¦¬
      if (row * cell <= mine) {
        alert("ì§€ë¢°ì˜ ê°œìˆ˜ëŠ” 'ê°€ë¡œ * ì„¸ë¡œ'ì˜ í¬ê¸°ë³´ë‹¤ í´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return;
      }

      // ê°œì¸ ë„ì „ 2. ìƒì„± ë¬¸ì œ ì˜ˆì™¸ ì²˜ë¦¬
      data = [];
      mines = [];
      $tbody.innerHTML = '';

      drawTable();
      openCount = 0;
      firstClick = true;
      startTime = new Date();
      interval = setInterval(() => {
        const time = Math.floor((new Date() - startTime) / 1000);
        $timer.textContent = `${time}ì´ˆ`;
      }, 1000);
    }
    $form.addEventListener('submit', onSubmit);

    function plantMine() {
      const candidate = Array(row * cell).fill().map((arr, i) => {
        return i;
      });
      const shuffle = [];
      while (candidate.length > row * cell - mine) {
        const chosen = candidate.splice(Math.floor(Math.random() * candidate.length), 1)[0];
        shuffle.push(chosen);
      }
      const data = [];
      for (let i = 0; i < row; i++) {
        const rowData = [];
        data.push(rowData);
        for (let j = 0; j < cell; j++) {
          rowData.push(CODE.NORMAL);
        }
      }

      for (let k = 0; k < shuffle.length; k++) {
        const ver = Math.floor(shuffle[k] / cell);
        const hor = shuffle[k] % cell;
        data[ver][hor] = CODE.MINE;
        mines.push({ rowIndex: ver, cellIndex: hor }); // ì§€ë¢° ë°°ì—´ì— ì¶”ê°€
      }
      return data;
    }

    function countMine(rowIndex, cellIndex) {
      const mines = [CODE.MINE, CODE.QUESTION_MINE, CODE.FLAG_MINE];
      let i = 0;
      mines.includes(data[rowIndex - 1]?.[cellIndex - 1]) && i++;
      mines.includes(data[rowIndex - 1]?.[cellIndex]) && i++;
      mines.includes(data[rowIndex - 1]?.[cellIndex + 1]) && i++;
      mines.includes(data[rowIndex][cellIndex - 1]) && i++;
      mines.includes(data[rowIndex][cellIndex + 1]) && i++;
      mines.includes(data[rowIndex + 1]?.[cellIndex - 1]) && i++;
      mines.includes(data[rowIndex + 1]?.[cellIndex]) && i++;
      mines.includes(data[rowIndex + 1]?.[cellIndex + 1]) && i++;
      return i;
    }

    function open(rowIndex, cellIndex) {
      if (data[rowIndex]?.[cellIndex] >= CODE.OPENED) return;
      const target = $tbody.children[rowIndex]?.children[cellIndex];
      if (!target) {
        return;
      }
      const count = countMine(rowIndex, cellIndex);
      target.textContent = count || '';
      target.className = 'opened';
      data[rowIndex][cellIndex] = count;
      openCount++;
      console.log(openCount);
      if (openCount === row * cell - mine) {
        const time = (new Date() - startTime) / 1000;
        clearInterval(interval);
        $tbody.removeEventListener('contextmenu', onRightClick);
        $tbody.removeEventListener('click', onLeftClick);
        setTimeout(() => {
          alert(`ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤! ${time}ì´ˆê°€ ê±¸ë ¸ìŠµë‹ˆë‹¤.`);
        }, 5);
      }
      return count;
    }

    function openAround(rI, cI) {
      setTimeout(() => {
        const count = open(rI, cI);
        if (count === 0) {
          openAround(rI - 1, cI - 1);
          openAround(rI - 1, cI);
          openAround(rI - 1, cI + 1);
          openAround(rI, cI - 1);
          openAround(rI, cI + 1);
          openAround(rI + 1, cI - 1);
          openAround(rI + 1, cI);
          openAround(rI + 1, cI + 1);
        }
      }, 0);
    }

    function onLeftClick(event) {
      const target = event.target; // td íƒœê·¸ê² ì£ ?
      const rowIndex = target.parentNode.rowIndex;
      const cellIndex = target.cellIndex;
      let cellData = data[rowIndex][cellIndex];
      // Self Check ì²« ë²ˆì§¸ë¡œ í´ë¦­í•œ ì¹¸ì€ ì§€ë¢°ê°€ ì—†ê²Œ ë§Œë“ ë‹¤.
      if (firstClick) {
        firstClick = false;

        // ì§€ë¢°ë¥¼ í´ë¦­í–ˆëŠ”ì§€ í™•ì¸í•œë‹¤.
        let isMine = false;
        let targetMine = null;
        for (const mine of mines) {
          if (mine.rowIndex === rowIndex && mine.cellIndex === cellIndex) {
            isMine = true;
            targetMine = mine;
            break;
          }
        }

        // ì§€ë¢°ë¥¼ í´ë¦­í–ˆë‹¤ë©´ ì§€ë¢°ë¥¼ ì˜®ê¸´ë‹¤.
        if (isMine) {
          const max = row * cell;
          const normalData = [];
          data.forEach((row, rowIndex) => {
            row.forEach((cell, cellIndex) => {
              if (cell === CODE.NORMAL) {
                normalData.push({ rowIndex, cellIndex });
              }
            })
          })
          const randomIndex = Math.floor(Math.random() * normalData.length);
          const normalRowIndex = normalData[randomIndex].rowIndex;
          const normalCellIndex = normalData[randomIndex].cellIndex;
          data[normalRowIndex][normalCellIndex] = CODE.MINE;
          data[rowIndex][cellIndex] = CODE.NORMAL;
          cellData = CODE.NORMAL;
          targetMine.rowIndex = normalRowIndex;
          targetMine.cellIndex = normalCellIndex;
        }
      }

      if (cellData === CODE.NORMAL) { // ë‹«íŒ ì¹¸ì´ë©´
        openAround(rowIndex, cellIndex); // ì£¼ë³€ ì¹¸ë„ ì—°ë‹¤
      } else if (cellData === CODE.MINE) { // ì§€ë¢° ì¹¸ì´ë©´
        // Self Check ì§€ë¢° ì¹¸ì„ í´ë¦­í•˜ë©´ ëª¨ë“  ì§€ë¢° ìœ„ì¹˜ë¥¼ ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì¤€ë‹¤.
        mines.forEach((mine) => {
          $tbody.children[mine.rowIndex].children[mine.cellIndex].textContent = CODE_TEXT.MINE;
        })

        target.textContent = 'ğŸ’¥';
        target.className = 'opened';
        $tbody.removeEventListener('contextmenu', onRightClick);
        $tbody.removeEventListener('click', onLeftClick);

        // ê°œì¸ ë„ì „ 4. í­íƒ„ í´ë¦­ì‹œ íƒ€ì´ë¨¸ê°€ ë©ˆì¶”ê³  í­íƒ„ì´ í„°ì¡Œë‹¤ëŠ” alert í‘œì‹œ
        clearInterval(interval);
        setTimeout(() => {
          alert(`í­íƒ„ì´ í„°ì¡ŒìŠµë‹ˆë‹¤!`);
        }, 5);
      } // ë‚˜ë¨¸ì§€ëŠ” ë¬´ì‹œ
    }

    function onRightClick(event) {
      event.preventDefault();
      const target = event.target;
      const rowIndex = target.parentNode.rowIndex;
      const cellIndex = target.cellIndex;
      const cellData = data[rowIndex][cellIndex];

      if (cellData === CODE.MINE) { // ì§€ë¢°ë©´
        data[rowIndex][cellIndex] = CODE.QUESTION_MINE; // ë¬¼ìŒí‘œ ì§€ë¢°ë¡œ
        target.className = 'question';
        target.textContent = CODE_TEXT.QUESTION;
      } else if (cellData === CODE.QUESTION_MINE) { // ë¬¼ìŒí‘œ ì§€ë¢°ë©´
        data[rowIndex][cellIndex] = CODE.FLAG_MINE; // ê¹ƒë°œ ì§€ë¢°ë¡œ
        target.className = 'flag';
        target.textContent = CODE_TEXT.FLAG;
      } else if (cellData === CODE.FLAG_MINE) { // ê¹ƒë°œ ì§€ë¢°ë©´
        data[rowIndex][cellIndex] = CODE.MINE; // ì§€ë¢°ë¡œ
        target.className = '';
        target.textContent = '';
      } else if (cellData === CODE.NORMAL) { // ë‹«íŒ ì¹¸ì´ë©´
        data[rowIndex][cellIndex] = CODE.QUESTION; // ë¬¼ìŒí‘œë¡œ
        target.className = 'question';
        target.textContent = CODE_TEXT.QUESTION;
      } else if (cellData === CODE.QUESTION) { // ë¬¼ìŒí‘œë©´
        data[rowIndex][cellIndex] = CODE.FLAG; // ê¹ƒë°œìœ¼ë¡œ
        target.className = 'flag';
        target.textContent = CODE_TEXT.FLAG;
      } else if (cellData === CODE.FLAG) { // ê¹ƒë°œì´ë©´
        data[rowIndex][cellIndex] = CODE.NORMAL; // ë‹«íŒ ì¹¸ìœ¼ë¡œ
        target.className = '';
        target.textContent = '';
      }
    }

    function drawTable() {
      data = plantMine();
      data.forEach((row) => {
        const $tr = document.createElement('tr');
        row.forEach((cell) => {
          const $td = document.createElement('td');
          if (cell === CODE.MINE) {
            $td.textContent = '';
          }
          $tr.append($td);
        });
        $tbody.append($tr);
        $tbody.addEventListener('contextmenu', onRightClick);
        $tbody.addEventListener('click', onLeftClick);
      })
    }
  </script>
</body>

</html>